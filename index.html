<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IIITT Academic Cockpit</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #ffffff; --text: #1a1a1a; --card-bg: #f4f4f9; --accent: #2563eb;
            --success: #25d366; --danger: #dc2626; --border: #ddd; --warning: #f59e0b;
        }
        [data-theme="dark"] {
            --bg: #121212; --text: #e0e0e0; --card-bg: #1e1e1e; --accent: #3b82f6; --border: #333;
        }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; transition: 0.3s; display: flex; justify-content: center; padding: 20px; margin: 0; }
        #calculator-container { max-width: 900px; width: 100%; background: var(--card-bg); padding: 2rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .nav-bar { display: flex; justify-content: space-between; align-items: center; background: var(--bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; }
        #input-section { display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; margin-bottom: 2rem; }
        input, select, button { padding: 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: var(--text); }
        button { cursor: pointer; font-weight: 600; }
        #add-course-btn { background: var(--accent); color: white; border: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border); }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 2rem; }
        .summary-card { padding: 1.5rem; border-left: 5px solid var(--accent); background: var(--bg); border-radius: 4px; margin-bottom: 20px; }
        .action-footer { margin-top: 2rem; display: flex; gap: 12px; flex-wrap: wrap; }
        .btn-whatsapp { background: var(--success); color: white; border: none; }
        .btn-report { background: var(--accent); color: white; border: none; }
        .btn-ai { background: var(--warning); color: #000; border: none; }
        @media (max-width: 600px) { #input-section { grid-template-columns: 1fr; } .summary-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
<div id="calculator-container">
    <header>
        <h1>IIITT Academic Cockpit</h1>
        <button id="theme-toggle-btn">üåô Toggle Theme</button>
    </header>
    <div class="nav-bar">
        <div>
            <label><strong>Semester:</strong></label>
            <select id="sem-select">
                <option value="Sem 1">Semester 1</option><option value="Sem 2">Semester 2</option>
                <option value="Sem 3">Semester 3</option><option value="Sem 4">Semester 4</option>
                <option value="Sem 5">Semester 5</option><option value="Sem 6">Semester 6</option>
                <option value="Sem 7">Semester 7</option><option value="Sem 8">Semester 8</option>
            </select>
        </div>
        <div id="status-tag">Status: Ready</div>
    </div>
    <div class="summary-card" style="border-left-color: var(--warning);">
        <h3>AI Fast-Entry</h3>
        <input type="file" id="ai-upload" accept="image/*" style="display: none;">
        <button onclick="document.getElementById('ai-upload').click()" class="btn-ai">üì∏ Scan Grade Sheet</button>
        <span id="ai-status" style="margin-left: 10px; font-size: 0.85rem; font-weight: bold;"></span>
    </div>
    <section id="input-section">
        <input type="text" id="course-name" placeholder="Course Name">
        <input type="number" id="course-credits" placeholder="Credits" min="1">
        <select id="course-grade">
            <option value="S">S (10)</option><option value="A">A (9)</option>
            <option value="B">B (8)</option><option value="C">C (7)</option>
            <option value="D">D (6)</option><option value="E">E (5)</option>
            <option value="F">F (0)</option>
        </select>
        <button id="add-course-btn">Add Course</button>
    </section>
    <table>
        <thead><tr><th>Course</th><th>Credits</th><th>Grade</th><th>Action</th></tr></thead>
        <tbody id="course-table-body"></tbody>
    </table>
    <div class="summary-card">
        <h3>Academic Trend</h3>
        <canvas id="progressChart" style="max-height: 250px;"></canvas>
    </div>
    <div class="summary-grid">
        <div class="summary-card">
            <small id="cur-sem-label">Sem 1</small>
            <h3>Semester SGPA</h3>
            <h2 id="sgpa-display">0.00</h2>
        </div>
        <div class="summary-card" style="border-left-color: #10b981;">
            <small>Overall Progress</small>
            <h3>Cumulative CGPA</h3>
            <h2 id="cgpa-display">0.00</h2>
        </div>
    </div>
    <div class="action-footer">
        <button onclick="generateFullReport()" class="btn-report">üìÑ Full Transcript</button>
        <button onclick="shareFullReportWA()" class="btn-whatsapp">üü¢ Share Summary (WA)</button>
        <button id="clear-data-btn" style="color: var(--danger); border-color: var(--danger);">üóëÔ∏è Reset All</button>
    </div>
</div>

<script>
    const SCALE = {'S':10,'A':9,'B':8,'C':7,'D':6,'E':5,'F':0};
    let history = JSON.parse(localStorage.getItem('IIITT_DATA')) || { "Sem 1": [] };
    let currentSem = "Sem 1";
    let progressChart = null;

    function getStats(courses) {
        let c = 0, p = 0;
        courses.forEach(x => { c += x.credits; p += (x.credits * SCALE[x.grade]); });
        return { c, p, g: c === 0 ? "0.00" : (p / c).toFixed(2) };
    }

    function getCGPA() {
        let tc = 0, tp = 0;
        Object.values(history).forEach(s => { const r = getStats(s); tc += r.c; tp += r.p; });
        return tc === 0 ? "0.00" : (tp / tc).toFixed(2);
    }

    function updateChart() {
        const ctx = document.getElementById('progressChart').getContext('2d');
        const labels = Object.keys(history).sort();
        const data = labels.map(s => getStats(history[s]).g);
        if (progressChart) progressChart.destroy();
        progressChart = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: [{ label: 'SGPA', data: data, borderColor: '#2563eb', tension: 0.3, fill: true, backgroundColor: 'rgba(37, 99, 235, 0.1)' }] },
            options: { responsive: true, scales: { y: { min: 0, max: 10 } }, plugins: { legend: { display: false } } }
        });
    }

    function updateUI() {
        const courses = history[currentSem] || [];
        document.getElementById('course-table-body').innerHTML = courses.map((x, i) => `<tr><td>${x.name}</td><td>${x.credits}</td><td>${x.grade}</td><td><button onclick="removeItem(${i})" style="border:none; background:none; cursor:pointer;">‚ùå</button></td></tr>`).join('');
        document.getElementById('cur-sem-label').textContent = currentSem;
        document.getElementById('sgpa-display').textContent = getStats(courses).g;
        document.getElementById('cgpa-display').textContent = getCGPA();
        localStorage.setItem('IIITT_DATA', JSON.stringify(history));
        updateChart();
    }

    function removeItem(i) { history[currentSem].splice(i, 1); updateUI(); }

    async function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 1200;
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.7);
                };
            };
        });
    }

    document.getElementById('ai-upload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const status = document.getElementById('ai-status');
        status.textContent = "‚åõ Optimizing & Scanning...";
        const compressedBlob = await compressImage(file);
        const formData = new FormData();
        formData.append('file', compressedBlob, 'scan.jpg');
        try {
            const res = await fetch('https://your-python-backend.onrender.com/parse-grades', { method: 'POST', body: formData });
            const result = await res.json();
            if (result.status === "success") {
                result.data.forEach(item => { history[currentSem].push({ name: item.name, credits: Number(item.credits), grade: item.grade }); });
                updateUI();
                status.textContent = "‚úÖ Done!";
            }
        } catch (err) { status.textContent = "‚ö†Ô∏è Error"; }
    });

    function generateFullReport() {
        const win = window.open('', '_blank');
        let h = `<html><head><title>Transcript</title><style>body{font-family:sans-serif;padding:30px;}table{width:100%;border-collapse:collapse;margin-top:10px;}th,td{border:1px solid #ddd;padding:8px;}header{border-bottom:2px solid #2563eb;}</style></head><body><header><h1>IIITT Consolidated Transcript</h1></header>`;
        Object.keys(history).sort().forEach(s => {
            if (history[s].length === 0) return;
            h += `<h3>${s}</h3><table><thead><tr><th>Course</th><th>Credits</th><th>Grade</th></tr></thead><tbody>`;
            h += history[s].map(x => `<tr><td>${x.name}</td><td>${x.credits}</td><td>${x.grade}</td></tr>`).join('');
            h += `</tbody></table><p>SGPA: <b>${getStats(history[s]).g}</b></p><hr>`;
        });
        h += `<h2>Final CGPA: ${getCGPA()}</h2></body></html>`;
        win.document.write(h); win.document.close(); win.print();
    }

    function shareFullReportWA() {
        let t = `üìä *IIITT SUMMARY*\n\n`;
        Object.keys(history).sort().forEach(s => { if (getStats(history[s]).g > 0) t += `üîπ *${s}:* ${getStats(history[s]).g}\n`; });
        t += `\nüèÜ *TOTAL CGPA: ${getCGPA()}*\n\nGenerated via IIITT Cockpit.`;
        window.open(`https://wa.me/?text=${encodeURIComponent(t)}`, '_blank');
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.documentElement.setAttribute('data-theme', localStorage.getItem('THEME') || 'light');
        document.getElementById('theme-toggle-btn').addEventListener('click', () => {
            const t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', t); localStorage.setItem('THEME', t);
        });
        document.getElementById('sem-select').addEventListener('change', (e) => {
            currentSem = e.target.value; if (!history[currentSem]) history[currentSem] = []; updateUI();
        });
        document.getElementById('add-course-btn').addEventListener('click', () => {
            const n = document.getElementById('course-name').value;
            const c = Number(document.getElementById('course-credits').value);
            const g = document.getElementById('course-grade').value;
            if (n && c > 0) {
                history[currentSem].push({name:n, credits:c, grade:g});
                document.getElementById('course-name').value = ""; document.getElementById('course-credits').value = "";
                updateUI();
            }
        });
        document.getElementById('clear-data-btn').addEventListener('click', () => { if(confirm("Wipe all?")){ history = {"Sem 1":[]}; updateUI(); } });
        updateUI();
    });
</script>
</body>
</html>